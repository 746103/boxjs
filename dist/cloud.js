(()=>{var e={38:()=>{},969:e=>{"use strict";e.exports={}}},t={};function s(o){var i=t[o];if(void 0!==i)return i.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,s),n.exports}(()=>{"use strict";var e,t,o;!function(e){e.Surge="Surge",e.Loon="Loon",e.QuanX="QuanX",e.Shadowrocket="Shadowrocket",e.Node="Node"}(e||(e={})),function(e){e.Response="http-response",e.Request="http-request",e.Script="run-script"}(t||(t={})),function(e){e[e.BASE=0]="BASE",e[e.HTTP=1]="HTTP",e[e.SYS=2]="SYS",e[e.OTHER=3]="OTHER"}(o||(o={}));class i extends Error{constructor(e,t=o.BASE){super(e),this.name="baseErr",this.code=t,this.stack=(new Error).stack,Object.setPrototypeOf(this,i.prototype)}}class n{constructor(e,t){this.isMute=!1,this.logList=[],this.logSeparator="\n\n",this.appName=e,this.namespace=t,this.startTime=(new Date).getTime(),this.log(`🔔${this.appName}, 开始!`),this.initAction(),this.initEnv();let o=this.getStore("mute");this.isMute="true"==o,s(969)}initAction(){"undefined"!=typeof $response?this.action=t.Response:"undefined"!=typeof $request?this.action=t.Request:this.action=t.Script,this.log("脚本类型为："+this.action)}async doAction(){switch(this.action){case t.Request:this.result=await this.doRequestAction($request);break;case t.Response:this.result=await this.doResponseAction($request,$response);break;case t.Script:this.result=await this.doScriptAction();break;default:this.log(this.appName,"Unknow Action","未知的脚本类型"),this.result=!1}!1===this.result&&this.msg(this.appName,"不合法的脚本","请检查脚本配置信息")}run(){this.doAction().catch((e=>{e instanceof i?(this.log(""+e.code),e.code==o.BASE?this.msg(this.appName,e.message,""):e.code==o.HTTP?Math.random()>.8?this.msg(this.appName,"网络异常："+e.message,""):this.log(this.appName,"网络异常Log:"+e.message,""):this.log(e.message,"")):this.log(e),this.result=this.ajaxFailResult(e.message||e)})).finally((()=>{this.done()}))}transParams(e){return Object.keys(e).map((t=>`${t}=${encodeURIComponent(e[t])}`)).join("&")}httpResponseResult(e,t={}){return{response:{status:200,body:"string"==typeof e?e:JSON.stringify(e),headers:{"Content-Type":"application/json; charset=utf-8","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST,GET","Access-Control-Allow-Headers":"Origin, X-Requested-With, Content-Type, Accept",...t}}}}randomString(e){for(var t="",s=0;s<e;s++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}handelLogHttp(){this.log(`运行 》 ${this.appName}系统运行日志http服务器`);let e=this.getStore(n.APP_LOG_KEY)||"";const t=new RegExp(this.logSeparator,"g");return e=e.replace(t,"<br>"),this.httpResponseResult(e,{"Content-Type":"text/html;charset=utf-8"})}send(e){return new Promise(((t,s)=>{this.doRequest(e,((e,n,r)=>{e?s(new i(e,o.HTTP)):t(n)}))}))}async post(e){return e.method="post",await this.send(e)}async get(e){return e.method="get",await this.send(e)}doRequest(t,s=((e,t,s)=>{})){const o=t.method?t.method.toLocaleLowerCase():"post";t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.env==e.Surge||this.env==e.Shadowrocket||this.env==e.Loon?(this.env==e.Surge&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient[o](t,((e,t,o)=>{!e&&t&&(t.body=o,t.statusCode=t.status?t.status:t.statusCode,t.status=t.statusCode),s(e,t,o)}))):this.env==e.QuanX?(t.method=o,this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then((e=>{const{statusCode:t,statusCode:o,headers:i,body:n}=e;s(null,{status:t,statusCode:o,headers:i,body:n},n)}),(e=>s(e&&e.error||"UndefinedError",null,null)))):this.env==e.Node&&this.print("nodejs http request",t,this.env)}ajaxSuccessResult(e,t=null){let s={time:+new Date,datetime:this.date("yyyy-MM-dd HH:mm:ss"),code:1,msg:e,data:t};return this.httpResponseResult(s)}ajaxFailResult(e,t=null){let s={time:+new Date,datetime:this.date("yyyy-MM-dd HH:mm:ss"),code:0,msg:e,data:t};return this.httpResponseResult(s)}done(){const t=((new Date).getTime()-this.startTime)/1e3;if(this.print("运行 response: "+JSON.stringify(this.result)),this.log(`🔔${this.appName}, 结束! 🕛 ${t} 秒 ${this.logSeparator}`),this.env==e.Node)process.exit(1);else{let e=this.getStore(n.APP_LOG_KEY)||"";e=e.split(this.logSeparator).slice(0,1e4).join(this.logSeparator),e=this.logList.join("")+e,this.setStore(n.APP_LOG_KEY,e),this.print("注意本次运行日志已缓存到变量 "+this.namespace+"."+n.APP_LOG_KEY),$done(this.result)}}msg(t,s,o){this.isMute||(this.log("==============📣系统通知📣=============="+this.logSeparator+t+this.logSeparator+s+this.logSeparator+o),this.env==e.Surge||this.env==e.Shadowrocket||this.env==e.Loon?$notification.post(t,s,o):this.env==e.QuanX&&$notify(t,s,o))}print(...e){e=e.map((e=>this.date("yyyy-MM-dd HH:mm:ss")+" "+e+this.logSeparator)),console.log(e.join(this.logSeparator))}log(...e){(e=e.map((e=>this.date("yyyy-MM-dd HH:mm:ss")+" "+("string"==typeof e?e:JSON.stringify(e))+this.logSeparator))).length>0&&(this.logList=[...this.logList,...e]),console.log(e.join(this.logSeparator))}getStore(t,s=!0){return s&&(t=this.namespace+"."+t),this.env==e.Surge||this.env==e.Shadowrocket||this.env==e.Loon?$persistentStore.read(t):this.env==e.QuanX?$prefs.valueForKey(t):null}setStore(t,s,o=!0){return o&&(t=this.namespace+"."+t),this.env==e.Surge||this.env==e.Shadowrocket||this.env==e.Loon?$persistentStore.write(s,t):this.env==e.QuanX&&$prefs.setValueForKey(s,t)}initEnv(){"undefined"!=typeof $task?this.env=e.QuanX:"undefined"!=typeof $loon?this.env=e.Loon:"undefined"!=typeof $rocket?this.env=e.Shadowrocket:"undefined"!=typeof $httpClient&&"undefined"==typeof $loon?this.env=e.Surge:this.env=e.Node,this.log("当前APP为: "+this.env)}date(e,t=""){const s=t?new Date(t):new Date;let o={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let t in o){let s=o[t];new RegExp("("+t+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?s:("00"+s).substr((""+s).length)))}return e}getSignCount(){let e=this.getStore("sign_count"),t=this.date("yyyyMMdd");if(e){let[s,o]=e.split("_");return s==t&&o?Number(o):(this.setStore("sign_count",`${t}_0`),0)}return this.setStore("sign_count",`${t}_0`),0}incSignCount(){let e=this.getSignCount();e++;let t=this.date("yyyyMMdd");this.setStore("sign_count",`${t}_${e}`)}}n.APP_LOG_KEY="boxjs-log";const r=n;s(38);class a extends r{async doRequestAction(e){if(e.url.includes("cloud.log"))return this.handelLogHttp();if(e.url.includes("somersaultcloud.xyz/user/profile")||e.url.includes("somersaultcloud.top/user/profile"))return e.headers&&e.headers.Cookie?(this.log("读取header成功",e.headers),this.setStore("login_cookie",e.headers.Cookie),this.log("读取cookie成功",e.headers.Cookie),this.msg(this.appName,"读取cookie成功","")):(this.log("读取cookie失败",e.headers),this.msg(this.appName,"读取cookie失败","")),{};if(!e.url.includes("cloud.json"))return!1;{const e=`${a.BASE_URL}user`,t={url:e,headers:{Cookie:this.getStore("login_cookie")??"","user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.42",referer:e}},s=await this.get(t);try{const e=this.exportData(s.body);return this.ajaxSuccessResult("获取个人信息",e)}catch(e){throw new i("登录状态可能已经失效,"+e?.message)}}}doResponseAction(e,t){return!1}async doScriptAction(){return await this.handelSign(),{}}async handelSign(){this.log("运行 》 筋斗云签到");const e=`${a.BASE_URL}user/checkin`,t={url:e,headers:{Cookie:this.getStore("login_cookie")??"","user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.42",referer:e}};this.log("Http request:"+t.url);let s=await this.post(t);try{const e=JSON.parse(s.body);this.msg(this.appName,e.msg,JSON.stringify(e))}catch(e){throw new i("登录状态可能已经失效,"+e?.message)}}exportData(e){let[,t,s]=/<h4>剩余流量<\/h4>\n\s+<\/div>\n\s+<div class="card-body">\n\s+<span class="counter">(.*)?<\/span> (MB|GB|KB)/.exec(e)??[],[,o,i]=/<h4>同时在线设备数<\/h4>\n\s+<\/div>\n\s+<div class="card-body">\n\s+<span class="counter">(\d+)<\/span> \/ <span class="counterup">(\d+)<\/span>/.exec(e)??[],[,n]=/今日已用: (.*?)<\/li>/.exec(e)??[],[,r]=/上次使用时间: (.*?)<\/li>/.exec(e)??[],[,a]=/<h4>钱包余额<\/h4>\n\s+<\/div>\n\s+<div class="card-body">\n\s+¥\s+<span class="counter">(.*)?<\/span>/.exec(e)??[],[,h]=/累计获得返利金额: ¥(.*?)<\/li>/.exec(e)??[],l={remain_flow:t+s,online:o,sum:i,used_flow:n,last_used_date:r,momey:a,commission:h};return this.log("↓ exportData"),this.log(JSON.stringify(l)),l}}a.BASE_URL="https://www.somersaultcloud.xyz/",new a("筋斗云","gsonhub.cloud").run()})()})();